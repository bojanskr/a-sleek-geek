---
layout: post
title: Using a .NET assembly in SQL Server 2008
date: 2015-03-12 18:44:15.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- SQLSERVER
tags:
- ".NET"
meta:
  publicize_facebook_url: https://facebook.com/10153119997784544
  publicize_linkedin_url: ''
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
  _wpas_done_10664483: '1'
  _publicize_done_external: a:2:{s:8:"facebook";a:2:{i:10153119055144544;b:1;i:24824976;s:52:"https://facebook.com/109859327422450_159338049141244";}s:7:"twitter";a:1:{i:23158388;s:55:"https://twitter.com/bojanskr/status/1299110512492515328";}}
  publicize_google_plus_url: https://plus.google.com/109496988347398087332/posts/LP55WCSFjoo
  _wpas_done_10664478: '1'
  publicize_twitter_user: bojanskr
  publicize_twitter_url: http://t.co/gFJlJ2flgH
  _wpas_done_10664475: '1'
  _wpas_done_10664490: '1'
  _publicize_job_id: '48192115718'
  _publicize_done_22258584: '1'
  _wpas_done_23158388: '1'
  _publicize_done_22258588: '1'
  _wpas_done_23158396: '1'
  _publicize_done_23096508: '1'
  _wpas_done_24824976: '1'
  _import_session_id: 5f57b340a397b
  _import_original_post_id: '45'
  original_post_id: '1655'
  _wp_old_slug: '1655'
author:
  login: bojanskr
  email: bojanskr@gmail.com
  display_name: TehBoyan
  first_name: Bojan
  last_name: Skrchevski
permalink: "/2015/03/12/45/"
---
<p><!-- wp:paragraph --></p>
<p>Many times you fnd yourself in a situation where you have to do something&nbsp;that seems too complex to implement in TSQL or you just want to use some feature&nbsp;from the .NET framework, or you already have something implemented in an&nbsp;assembly and you want to use it in your stored procedure or function. While TSQL&nbsp;is very powerfull and there are lots of things you can accomplish the answer to&nbsp;the above is to just use a .NET assembly in your TSQL code.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:more --><br />
<!--more--><br />
<!-- /wp:more --></p>
<p><!-- wp:paragraph --></p>
<p>Let's say, for the sake of this presentation we create the following class:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted {"className":"brush: csharp"} --></p>
<pre class="wp-block-preformatted brush: csharp">namespace SqlClr
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using Microsoft.SqlServer.Server;

    public class SqlClrClass
    {
        /// &lt;summary&gt;
        /// Returns a new string for a sql function.
        /// &lt;/summary&gt;
        /// &lt;param name="inputString"&gt;Original string(just for showing an input parameter).&lt;/param&gt;
        /// &lt;returns&gt;Formated string.&lt;/returns&gt;
        [SqlProcedure]
        public static string GetFunctionString(string inputString)
        {
            return string.Format("Original string was: {0}", inputString);
        }
    }
}
</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Notice that we have to import the&nbsp; <span class="auto-style1">Microsoft.SqlServer.Server</span> namespace&nbsp;and we need to add <span class="auto-style1">[SqlProcedure]</span> attribute to our method. This is essential for&nbsp;this to work.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Since I'm using VS2010 and .NET Framework 4.0 and SQL Server 2008 R2, which&nbsp;at the time doesn't support .NET 4 assemblies integration. I have to build the&nbsp;assembly for .NET Framework 3.5. In order to do that you go to the project's&nbsp;properties and in the Application tab choose .NET Framework 3.5 as the target&nbsp;framework.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Next we to to the SQL Server.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>In order to use our assembly we have to enable managed code execution feature<br />of the SQL Server which is disabled by default. So, to do that we need to<br />execute the following query:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted {"className":"brush: sql"} --></p>
<pre class="wp-block-preformatted brush: sql">sp_configure 'clr enable', 1
GO
RECONFIGURE
GO
</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>This will have our assembly execution enabled and we're ready for our next&nbsp;step.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>To register an assembly you need to have owner rights on your database or you&nbsp;should be the local system admin or server admin.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Now we are ready to register our assembly with the following code:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted {"className":"brush: sql"} --></p>
<pre class="wp-block-preformatted brush: sql">CREATE ASSEMBLY [SqlClr]
AUTHORIZATION dbo -- or your user
FROM '{Your path to the assembly}\SqlClr.dll'
WITH PERMISSION_SET = SAFE
GO</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Or you can just go to <span class="auto-style1">[your database] -&gt;&nbsp;Programmabiliy</span> right click on <span class="auto-style1">Assemblies&nbsp;</span>and choose <span class="auto-style1">New Assembly... </span>and choose the&nbsp;specific options from there.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>It is very important to notice here that if you are using other assemblies in&nbsp;your code either from the .NET Framework or others you need to add them here&nbsp;also by providing the path to them. For this example we don't need to do that as&nbsp;we are not referencing other assemblies from our code other that normal.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Once the query is executed or you added the assembly using the&nbsp;<span class="auto-style1">New Assembly...</span> window and we verify that the&nbsp;assembly is present in <span class="auto-style1">[your database] -&gt;&nbsp;Programmabiliy -&gt;Assemblies</span> we are ready for our next step.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The next step is to create a wrapper function for the method we are going to&nbsp;use from our assembly.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted {"className":"brush: sql"} --></p>
<pre class="wp-block-preformatted brush: sql">CREATE FUNCTION [dbo].[fn_GetFunctionString](@inputString [nvarchar](MAX))
RETURNS [nvarchar](MAX) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [SqlClr].[SqlClr].[GetFunctionString]</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>And we are all set to go.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>We can now just execute our function for test:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted {"className":"brush: sql"} --></p>
<pre class="wp-block-preformatted brush: sql">DECLARE @inputStr nvarchar(MAX);
DECLARE @result nvarchar(MAX);
SET @inputStr = 'Hello .NET assembly';
SELECT @result = dbo.[fn_GetFunctionString](@inputStr);</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>or use it in another stored procedure or whatever we want :)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>You should get the result:<span class="auto-style1"> The original string was:</span></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"><span class="auto-style1"> Hello .NET assembly</span></pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Until next time....Happy coding.</p>
<p><!-- /wp:paragraph --></p>
